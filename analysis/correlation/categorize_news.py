#!/usr/bin/env python3
"""
원본 뉴스 데이터에 카테고리 매핑
키워드 기반으로 10개 카테고리 분류
"""

import pandas as pd
from collections import Counter

# 카테고리 매핑 테이블 (도서 분류와 동일)
CATEGORY_KEYWORDS = {
    "주식투자/트레이딩": [
        "주식투자", "트레이더", "나스닥", "코스피", "종목", "매매", "손절매", "시가총액",
        "급락", "급등", "저점", "고점", "상승세", "외국인", "etf", "코스닥", "거래량",
        "시총", "변동성", "목표주가", "순매도", "레버리지", "서학개미", "매수세",
        "밸류에이션", "대형주", "공공기관", "구조조정", "상장지수펀드", "금융기관",
        "컨센서스", "사모펀드", "트레이딩", "개인 투자자", "초보 투자자", "투자자",
        "배당", "수익", "포트폴리오", "분산 투자", "장기 투자", "시세 차익", "밸류"
    ],
    "투자철학/대가": [
        "워런 버핏", "버핏", "가치 투자", "투자 철학", "서한", "주주", "명언",
        "필립 피셔", "피터 린치", "하워드 막스", "주주가치", "피셔", "린치",
        "하워드", "필립", "보통주", "투자 원칙", "통찰"
    ],
    "재테크/개인금융": [
        "재테크", "부자되는법", "종잣돈", "절세", "노후 준비", "연말 정산", "배당금",
        "현금 흐름", "원금", "계좌", "국민연금", "퇴직연금", "노후 자금", "자산",
        "절세 방법", "금융 지식", "재투자", "퇴직 연금", "배당 소득", "월배당"
    ],
    "거시경제/금융정책": [
        "금리", "인플레이션", "환율", "통화 정책", "기준 금리", "경기 순환",
        "디플레이션", "버블", "중앙은행", "한국은행", "연준", "한은", "기준금리",
        "유동성", "수출액", "달러", "gdp", "고환율", "유로", "거시 경제", "거시경제",
        "금리 인상", "경제 원리", "경제 개념", "글로벌 경제", "한국 경제", "실물 경제"
    ],
    "지정학/국제정세": [
        "트럼프", "우크라", "중국", "패권", "관세", "국제 질서", "지정학", "국가 전략",
        "자유 무역", "이스라엘", "공급망", "대만", "중동", "러시아", "국제 정세",
        "국제 정치", "도널드 트럼프", "국가 안보", "제2차 냉전", "양극"
    ],
    "부동산/실물자산": [
        "부동산 투자", "주택 가격", "집값", "건폐율", "용도지역", "금", "실물",
        "부동산", "재건축", "분양가", "금융당국", "금융사", "실거래", "보험금",
        "재개발", "주담대", "보증금", "금융권", "원자재", "보조금", "토지거래허가구역",
        "투자금", "갭투자", "지원금", "정비사업", "과징금", "금값", "원리금", "계약금",
        "임대료", "다주택자", "증거금", "임차인", "주택담보대출", "전셋값", "무주택자",
        "건물주", "월세"
    ],
    "기업경영/리더십": [
        "리더십", "경영자", "비즈니스 모델", "브랜드 전략", "경쟁력", "혁신 기업",
        "매출", "다각화", "영업이익", "브랜드", "임직원", "ceo", "매출액", "이사회",
        "순이익", "상장사", "경영진", "ipo", "경영", "상장", "지배구조", "최고경영자",
        "덕목", "대전환", "행동 방식", "실행력", "조직"
    ],
    "테크/스타트업": [
        "실리콘밸리", "스타트업", "AI", "프롬프트", "에이전트", "반도체", "휴머노이드",
        "오픈소스", "ai", "인공지능", "전기차", "클라우드", "빅테크", "데이터센터",
        "hbm", "자율주행", "로보틱스", "ces", "파운드리", "빅데이터", "오픈ai", "낸드",
        "중소벤처기업부", "드론", "실리콘", "밸리", "창업자", "오픈", "신경망", "컴퓨팅",
        "병렬", "반도체 산업", "엔비디아", "클로드", "트랜스포머", "모달", "커서"
    ],
    "경제이론/학술": [
        "거시 경제학", "미시 경제학", "케인스", "하이에크", "경쟁 시장", "외부 효과",
        "노벨 경제학", "행동경제학", "연구개발", "연구소", "실수요자", "수요예측",
        "효율성", "공급", "수요자", "경제학", "경제이론", "국부론", "생산요소시장"
    ],
    "금융시스템/위기": [
        "금융 위기", "금융 시스템", "화폐", "기축 통화", "부채", "가계 부채",
        "글로벌 금융 위기", "코인", "비트코인", "암호 화폐", "알트코인", "국제 금융 시장"
    ]
}


def categorize_news(text):
    """텍스트를 분석하여 가장 연관성 높은 카테고리 반환"""
    if not isinstance(text, str):
        return "미분류"

    text_lower = text.lower()
    category_scores = Counter()

    for category, keywords in CATEGORY_KEYWORDS.items():
        for kw in keywords:
            if kw.lower() in text_lower:
                category_scores[category] += 1

    if category_scores:
        return category_scores.most_common(1)[0][0]
    return "미분류"


def main():
    print("=" * 70)
    print("뉴스 카테고리 매핑 시작")
    print("=" * 70)

    # 원본 데이터 로드
    news_files = [
        '../원본 뉴스데이터(한경 25년)/20250101-20250331.xlsx',
        '../원본 뉴스데이터(한경 25년)/20250401-20250630.xlsx',
        '../원본 뉴스데이터(한경 25년)/20250701-20250930.xlsx',
        '../원본 뉴스데이터(한경 25년)/20251001-20251231.xlsx'
    ]

    print("\n[1] 원본 데이터 로드")
    news_dfs = []
    for f in news_files:
        df = pd.read_excel(f)
        news_dfs.append(df)
        print(f"  {f.split('/')[-1]}: {len(df):,}건")

    news_raw = pd.concat(news_dfs, ignore_index=True)
    print(f"  => 전체: {len(news_raw):,}건")

    # 날짜 처리
    news_raw['일자'] = pd.to_datetime(news_raw['일자'].astype(str), format='%Y%m%d')
    news_raw['년월'] = news_raw['일자'].dt.strftime('%Y-%m')

    # 카테고리 매핑 (제목 + 키워드 기반)
    print("\n[2] 카테고리 매핑 중...")
    news_raw['분류텍스트'] = news_raw['제목'].fillna('') + ' ' + news_raw['키워드'].fillna('')
    news_raw['카테고리'] = news_raw['분류텍스트'].apply(categorize_news)

    # 결과 요약
    print("\n[3] 카테고리 분류 결과")
    cat_counts = news_raw['카테고리'].value_counts()
    for cat, cnt in cat_counts.items():
        pct = cnt / len(news_raw) * 100
        print(f"  {cat:20s}: {cnt:6,}건 ({pct:5.1f}%)")

    # 저장
    output_file = 'news_2025_categorized.csv'
    news_raw.to_csv(output_file, index=False, encoding='utf-8-sig')
    print(f"\n[4] 저장 완료: {output_file}")

    # 월별 카테고리 집계도 저장
    monthly_cat = news_raw.groupby(['년월', '카테고리']).size().unstack(fill_value=0)
    monthly_cat.to_csv('news_monthly_by_category.csv', encoding='utf-8-sig')
    print(f"    월별 집계: news_monthly_by_category.csv")

    print("\n" + "=" * 70)
    print("완료!")
    print("=" * 70)


if __name__ == "__main__":
    main()
